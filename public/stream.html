<!DOCTYPE html>
<html>
<head>
    <title>Zego Viewer</title>
    <style>
        body { font-family: Arial; text-align: center; padding: 20px; }
        #video-container { 
            width: 640px; 
            height: 360px; 
            background: black; 
            margin: 20px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #status {
            margin: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .error { background: #FFEBEE; color: #D32F2F; }
        .success { background: #E8F5E9; color: #388E3C; }
    </style>
</head>
<body>
    <h1>ZegoCloud Stream Viewer</h1>
    <div id="video-container">Waiting for stream...</div>
    <button id="watchBtn">Start Watching</button>
    <div id="status">Ready to connect</div>

    <!-- Self-hosted SDK solution -->
    <script src="/zego/ZegoExpressEngine.min.js"></script>
    
    <script>
    // Configuration - MUST match your Flutter app
    const config = {
        appID: 1173379578,
        appSign: "7094b1463e589f6c10d756d00a89648263426a00d725a02aadfb89dc553dc458",
        roomID: "streaming_001", // Must match Flutter app
        userID: "viewer_" + Math.floor(Math.random() * 10000),
        userName: "Viewer_" + Math.floor(Math.random() * 100)
    };

    const statusEl = document.getElementById('status');
    const watchBtn = document.getElementById('watchBtn');
    let zg = null;
    let currentStreamID = null;

    function updateStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.className = isError ? 'error' : 'success';
        console.log(message);
    }

    async function initialize() {
        try {
            // 1. Verify SDK loaded
            if (!window.ZegoExpressEngine) {
                throw new Error("Zego SDK not loaded. Please ensure /zego/ZegoExpressEngine.min.js exists on your server");
            }
            
            // 2. Create engine instance
            zg = new ZegoExpressEngine(config.appID, config.appSign);
            updateStatus("SDK initialized successfully");
            
            // 3. Set up event listeners
            zg.on('roomStreamUpdate', (roomID, updateType, streamList) => {
                if (updateType === 'ADD') {
                    currentStreamID = streamList[0].streamID;
                    playStream(currentStreamID);
                } else if (updateType === 'DELETE') {
                    stopPlaying();
                }
            });
            
            return true;
        } catch (error) {
            updateStatus(error.message, true);
            return false;
        }
    }

    async function startViewing() {
        try {
            watchBtn.disabled = true;
            updateStatus("Joining room...");
            
            // Join the same room as Flutter app
            await zg.loginRoom(config.roomID, 1, {
                userID: config.userID,
                userName: config.userName
            });
            
            updateStatus(`Joined room: ${config.roomID}`);
        } catch (error) {
            updateStatus("Join failed: " + error.message, true);
            watchBtn.disabled = false;
        }
    }

    async function playStream(streamID) {
        try {
            const container = document.getElementById('video-container');
            await zg.startPlayingStream(streamID, {
                container: container,
                video: true,
                audio: true
            });
            updateStatus(`Now playing: ${streamID}`);
        } catch (error) {
            updateStatus("Play failed: " + error.message, true);
        }
    }

    function stopPlaying() {
        if (currentStreamID && zg) {
            zg.stopPlayingStream(currentStreamID);
            document.getElementById('video-container').innerHTML = "Stream ended";
            updateStatus("Playback stopped");
        }
    }

    // Initialize when page loads
    window.addEventListener('DOMContentLoaded', async () => {
        const initialized = await initialize();
        if (initialized) {
            watchBtn.addEventListener('click', startViewing);
        } else {
            watchBtn.disabled = true;
            watchBtn.textContent = "SDK Not Available";
        }
    });
    </script>
</body>
</html>