<!DOCTYPE html>
<html>
<head>
    <title>ZegoCloud Viewer</title>
    <!-- Latest Zego SDK -->
    <script src="https://storage.zego.im/sdk/rtc/ZegoExpressEngine.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        #video-container { width: 640px; height: 360px; background: #000; margin: 20px auto; }
        #status { padding: 10px; margin: 10px; border-radius: 5px; }
        .error { background: #ffebee; color: #d32f2f; }
        .success { background: #e8f5e9; color: #388e3c; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ZegoCloud Stream Viewer</h1>
    <div id="video-container"></div>
    <button id="watch-btn">Start Watching</button>
    <div id="status">Ready to connect...</div>

    <script>
    const statusEl = document.getElementById('status');
    const watchBtn = document.getElementById('watch-btn');
    let zg = null;
    let currentStreamID = null;

    // Update status display
    function updateStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.className = isError ? 'error' : 'success';
        console.log(message);
    }

    // Initialize Zego engine
    async function initZego() {
        try {
            if (!window.ZegoExpressEngine) {
                throw new Error('Zego SDK not loaded. Check: 1. Internet 2. Ad-blockers 3. Console errors');
            }
            
            updateStatus('SDK loaded successfully');
            return true;
        } catch (error) {
            updateStatus(error.message, true);
            return false;
        }
    }

    // Start watching stream
    async function startViewing() {
        try {
            watchBtn.disabled = true;
            updateStatus('Connecting...');

            // 1. Get Zego credentials
            const res = await fetch("/stream-info");
            if (!res.ok) throw new Error('Failed to get stream info');
            const { appID, appSign, roomID, userID, userName } = await res.json();
            
            // 2. Create Zego instance
            zg = new ZegoExpressEngine(appID, appSign);
            
            // 3. Listen for stream updates
            zg.on('roomStreamUpdate', (roomID, updateType, streamList) => {
                if (updateType === 'ADD') {
                    updateStatus(`Found ${streamList.length} stream(s)`);
                    currentStreamID = streamList[0].streamID;
                    playStream(currentStreamID);
                } else if (updateType === 'DELETE') {
                    updateStatus('Stream ended');
                    stopPlaying();
                }
            });

            // 4. Join room (same as Flutter app)
            await zg.loginRoom(roomID, 1, { userID, userName });
            updateStatus(`Joined room: ${roomID}`);

        } catch (error) {
            updateStatus(`Error: ${error.message}`, true);
            watchBtn.disabled = false;
        }
    }

    // Play the stream
    async function playStream(streamID) {
        try {
            const container = document.getElementById('video-container');
            await zg.startPlayingStream(streamID, { 
                container: container,
                video: true,
                audio: true
            });
            updateStatus(`Playing: ${streamID}`);
        } catch (error) {
            updateStatus(`Play failed: ${error.message}`, true);
        }
    }

    // Stop playing
    function stopPlaying() {
        if (currentStreamID && zg) {
            zg.stopPlayingStream(currentStreamID);
            document.getElementById('video-container').innerHTML = '';
            updateStatus('Playback stopped');
        }
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', async () => {
        const initialized = await initZego();
        if (initialized) {
            watchBtn.addEventListener('click', startViewing);
        } else {
            watchBtn.disabled = true;
        }
    });

    // Cleanup
    window.addEventListener('beforeunload', () => {
        if (zg) {
            if (currentStreamID) zg.stopPlayingStream(currentStreamID);
            zg.logoutRoom();
        }
    });
    </script>
</body>
</html>