<!DOCTYPE html>
<html>
<head>
    <title>Zego Viewer</title>
    <meta charset="UTF-8">
    <!-- Main CDN with fallback -->
    <script>
    function loadZegoSDK() {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://storage.zego.im/sdk/rtc/ZegoExpressEngine.min.js';
            script.onload = () => resolve();
            script.onerror = () => {
                // Fallback to alternative CDN
                const fallbackScript = document.createElement('script');
                fallbackScript.src = 'https://cdn.jsdelivr.net/npm/zego-express-engine-webrtc@latest/sdk/ZegoExpressEngine.min.js';
                fallbackScript.onload = () => resolve();
                fallbackScript.onerror = () => reject('Failed to load Zego SDK from both sources');
                document.head.appendChild(fallbackScript);
            };
            document.head.appendChild(script);
        });
    }
    </script>
</head>
<body>
    <h1>ZegoCloud Stream Viewer</h1>
    <div id="video-container" style="width: 640px; height: 360px; background: #000; margin: 20px auto;"></div>
    <button id="watch-btn" style="padding: 10px 20px; font-size: 16px;">Start Watching</button>
    <div id="status" style="color: white; background: #333; padding: 15px; margin: 20px; border-radius: 5px; font-family: monospace;"></div>

    <script>
    // Global variables
    let zg = null;
    let currentStreamID = null;
    const statusEl = document.getElementById('status');
    const watchBtn = document.getElementById('watch-btn');

    // Update status function
    function updateStatus(message, isError = false) {
        statusEl.innerHTML = message;
        statusEl.style.color = isError ? '#ff4444' : '#44ff44';
        console.log(isError ? '❌ ' + message : 'ℹ️ ' + message);
    }

    // Initialize SDK
    async function initializeSDK() {
        try {
            updateStatus('Loading Zego SDK...');
            await loadZegoSDK();
            
            if (!window.ZegoExpressEngine) {
                throw new Error('Zego SDK not available after loading');
            }
            
            updateStatus('SDK loaded successfully');
            return true;
        } catch (error) {
            updateStatus(`SDK load failed: ${error.message}`, true);
            return false;
        }
    }

    // Start watching stream
    async function startViewing() {
        try {
            watchBtn.disabled = true;
            updateStatus('Initializing viewer...');

            // 1. Get stream info from server
            updateStatus('Fetching stream configuration...');
            const res = await fetch("/stream-info");
            if (!res.ok) throw new Error('Failed to get stream info');
            const { appID, appSign, roomID, userID, userName } = await res.json();
            
            // 2. Create Zego instance
            updateStatus('Creating Zego engine instance...');
            zg = new ZegoExpressEngine(appID, appSign);
            
            // 3. Set up event listeners
            zg.on('roomStreamUpdate', (roomID, updateType, streamList) => {
                if (updateType === 'ADD') {
                    updateStatus(`New stream detected: ${streamList.length} streams available`);
                    if (streamList.length > 0 && !currentStreamID) {
                        currentStreamID = streamList[0].streamID;
                        playStream(currentStreamID);
                    }
                } else if (updateType === 'DELETE') {
                    updateStatus(`Stream ended: ${streamList[0].streamID}`);
                    if (currentStreamID === streamList[0].streamID) {
                        stopPlaying();
                    }
                }
            });

            // 4. Join room
            updateStatus(`Joining room ${roomID}...`);
            await zg.loginRoom(roomID, 1, { userID, userName });
            updateStatus(`Successfully joined room as ${userName}`);

        } catch (error) {
            updateStatus(`Error: ${error.message}`, true);
            watchBtn.disabled = false;
        }
    }

    // Play stream function
    async function playStream(streamID) {
        try {
            updateStatus(`Starting playback for stream: ${streamID}`);
            const container = document.getElementById('video-container');
            
            await zg.startPlayingStream(streamID, {
                container: container,
                video: true,
                audio: true,
                muteAudio: false,
                muteVideo: false
            });
            
            updateStatus(`Now playing: ${streamID}`);
            container.style.background = 'transparent';

        } catch (error) {
            updateStatus(`Playback failed: ${error.message}`, true);
        }
    }

    // Stop playing function
    function stopPlaying() {
        if (currentStreamID && zg) {
            zg.stopPlayingStream(currentStreamID);
            currentStreamID = null;
            document.getElementById('video-container').style.background = '#000';
            updateStatus('Playback stopped');
        }
    }

    // Initialize when page loads
    window.addEventListener('DOMContentLoaded', async () => {
        const sdkLoaded = await initializeSDK();
        if (sdkLoaded) {
            watchBtn.addEventListener('click', startViewing);
            watchBtn.disabled = false;
        } else {
            watchBtn.disabled = true;
            watchBtn.textContent = 'SDK Not Available';
        }
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        if (zg) {
            if (currentStreamID) zg.stopPlayingStream(currentStreamID);
            zg.logoutRoom();
            zg.destroyEngine();
        }
    });
    </script>
</body>
</html>