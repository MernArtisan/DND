<!DOCTYPE html>
<html>
<head>
    <title>Zego Viewer - streaming_001</title>
    <style>
        body { font-family: Arial; text-align: center; padding: 20px; }
        #video-container { 
            width: 640px; 
            height: 360px; 
            background: black; 
            margin: 20px auto;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
        }
        #status {
            margin: 20px auto;
            padding: 15px;
            border-radius: 5px;
            max-width: 600px;
        }
        .error { background: #FFEBEE; color: #D32F2F; }
        .success { background: #E8F5E9; color: #388E3C; }
    </style>
</head>
<body>
    <h1>ZegoCloud Stream Viewer</h1>
    <div id="video-container">Stream will appear here</div>
    <button id="watchBtn" disabled>Loading SDK...</button>
    <div id="status">Initializing...</div>

    <script>
    // Configuration from your dashboard
    const config = {
        appID: 1173379578,
        appSign: "7094b1463e589f6c10d756d00a89648263426a00d725a02aadfb89dc553dc458",
        roomID: "streaming_001",
        userID: "viewer_" + Math.floor(Math.random() * 10000),
        userName: "Viewer_" + Math.floor(Math.random() * 100),
        streamID: "streaming_001_host_backtik_main"
    };

    const statusEl = document.getElementById('status');
    const watchBtn = document.getElementById('watchBtn');
    let zg = null;

    function updateStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.className = isError ? 'error' : 'success';
        console.log(message);
    }

    // Modern SDK loading without document.write
    function loadSDK() {
        return new Promise((resolve) => {
            const script = document.createElement('script');
            script.src = "https://storage.zego.im/sdk/rtc/ZegoExpressEngine.min.js";
            script.onload = () => resolve(true);
            script.onerror = () => {
                console.log("Primary CDN failed, trying fallback...");
                const fallbackScript = document.createElement('script');
                fallbackScript.src = "https://cdn.jsdelivr.net/npm/zego-express-engine-webrtc@latest/sdk/ZegoExpressEngine.min.js";
                fallbackScript.onload = () => resolve(true);
                fallbackScript.onerror = () => resolve(false);
                document.head.appendChild(fallbackScript);
            };
            document.head.appendChild(script);
        });
    }

    async function initialize() {
        try {
            updateStatus("Loading Zego SDK...");
            
            // 1. Load SDK properly
            const sdkLoaded = await loadSDK();
            if (!sdkLoaded || !window.ZegoExpressEngine) {
                throw new Error("Failed to load Zego SDK from all sources");
            }
            
            updateStatus("SDK loaded successfully");
            
            // 2. Create engine instance
            zg = new ZegoExpressEngine(config.appID, config.appSign);
            
            // 3. Set up event listeners
            zg.on('roomStreamUpdate', (roomID, updateType, streamList) => {
                if (updateType === 'ADD') {
                    updateStatus(`Found stream: ${streamList[0].streamID}`);
                    playStream(streamList[0].streamID);
                } else if (updateType === 'DELETE') {
                    updateStatus("Stream ended");
                    document.getElementById('video-container').innerHTML = "Stream ended";
                }
            });
            
            watchBtn.disabled = false;
            watchBtn.textContent = "Start Watching";
            updateStatus("Ready to connect");
            
            return true;
        } catch (error) {
            updateStatus(error.message, true);
            watchBtn.disabled = true;
            watchBtn.textContent = "SDK Not Available";
            return false;
        }
    }

    async function startViewing() {
        try {
            watchBtn.disabled = true;
            updateStatus("Joining room...");
            
            await zg.loginRoom(config.roomID, 1, {
                userID: config.userID,
                userName: config.userName
            });
            
            updateStatus(`Joined room: ${config.roomID}`);
            
            // Try playing the specific stream from dashboard
            playStream(config.streamID);
            
        } catch (error) {
            updateStatus("Error: " + error.message, true);
            watchBtn.disabled = false;
        }
    }

    async function playStream(streamID) {
        try {
            const container = document.getElementById('video-container');
            await zg.startPlayingStream(streamID, {
                container: container,
                video: true,
                audio: true
            });
            updateStatus(`Playing: ${streamID}`);
        } catch (error) {
            updateStatus("Play failed: " + error.message, true);
        }
    }

    // Initialize when page loads
    window.addEventListener('DOMContentLoaded', initialize);
    watchBtn.addEventListener('click', startViewing);
    </script>
</body>
</html>